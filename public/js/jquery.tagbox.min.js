(function(j){j.tagbox={defaults:{separator:/[,]/,className:"tag",fx:true,container:"div",suggestion_links:null,dictionary_map:null,autocomplete:null,autocomplete_action:"selection"}};j.fn.extend({tagbox:function(v){var r=this;var u=[];this.each(function t(){var z=j(this);v=jQuery.extend({},j.tagbox.defaults,v);if(v.autocomplete){if(v.autocomplete.constructor==String||v.autocomplete.constructor==Array){v.autocomplete=k(v.autocomplete,v).sort()}else{if(v.autocomplete.constructor==Function){}else{}}}v.tag_class="."+v.className;var y=this;v.tag=j('<span class="'+v.className+'"><label><span></span><input type="text" name="'+v.name+'" value=" " /><small class="close" title="close">Ã—</small></label></span>').get(0);p(v);if(z.is(":input")){var x=z;v.name=v.name||this.name;z.wrap("<"+v.container+' class="'+v.className+'"></'+v.container+">");z=z.parent().text(z.val());r.push(z.get(0));u.push(x.get(0));x.remove()}if(j.data(z.get(0),"settings")){return}j.data(z.get(0),"settings",v);z.click(function(A,B){j(this).tagboxNewTagAppend(B,v).find(v.tag_class+":last input").focus()}).bind("focus",function(A,B){j(this).trigger("remove_tag","");j(this).tagboxNewTagAppend(B,v)}).bind("add_tag",function(A,B){j(this).trigger("click",B)}).bind("remove_tag",function(A,B){s.call(this,B).remove()}).bind("toggle_tag",function(A,B){suggestion=n(B,v);if(s.call(this,B).length){suggestion.removeClass("active");j(this).trigger("remove_tag",B)}else{suggestion.addClass("active");j(this).trigger("add_tag",B)}});if(j.trim(z.text())){var w=k(j.trim(z.text()),v);z.text("");j.each(w,function(){if(j.trim(this)){z.tagboxNewTagAppend(this,v)}});if(v.suggestion_links){j(v.suggestion_links).each(function(){link=j(this);if(j.inArray(link.text(),w)!==-1){link.addClass("active")}})}if(j.isFunction(v.init)){v.init.call(this,w)}}if(v.suggestion_links){j(v.suggestion_links).live("click",function(A){A.preventDefault();z.trigger("toggle_tag",j(this).text())})}});return r.filter(function(x){var w=true;for(var y=0;y<u.length;y++){if(u[y]==r.get(x)){w=false}}return w});function s(w){return j(this).find(v.tag_class+" input").filter(function(){return j(this).val()==w}).closest(v.tag_class)}function q(w,x){w.find("input").val(x).siblings("span").html(d(x));return w}},tagboxNewTagAppend:function(q,r){return a.call(this,q,r,"append")},tagboxNewTagBefore:function(q,r){return a.call(this,q,r,"before")},tagboxNewTagAfter:function(q,r){return a.call(this,q,r,"after")}});function a(q,r,s){var t=h(q,r);this[s](t);t.find("input").keyup();return this}function p(q){j(q.tag).click(q.click).click(g).find("input").focus(q.focus).blur(q.blur).keydown(q.keydown).keyup(q.keyup).focus(i).blur(e).keydown(m).keyup(l)}function o(r){var q,r=r instanceof jQuery?j(r).get(0):r,s=j.data(r,"settings");if(typeof s!="undefined"&&s.hasOwnProperty("separator")){q=s}else{q=o(r.parentNode)}return q}function c(u,s){var t="";if(u.charAt(u.length-1).match(s.separator)){t=u.charAt(u.length-1)}var q=new RegExp(s.grouping+".*?"+s.grouping,"g"),r;r=u.replace(q,"").replace(/(\s)\s/g,"$1").split(s.separator);q=u.match(q);u=j.map(j.merge(q,r),function(v){if(v){return j.trim(v)}});u.push(t);return u}function f(s,t,r){if(typeof s=="string"){var s=new RegExp("^"+s,"i")}if(j.isFunction(t)){t=k(t.call(),r)}var q=[];j.each(t,function(v,u){var w;if(r.dictionary_map){w=r.dictionary_map.call(this,u)}else{w=u}if(w.match(s)){q.push(u)}});return q}function b(y,t){var q=y.selectionStart,D=y.value.substr(0,q);var r=new RegExp("^"+D,"i");if(!y.selectionStart&&document.selection&&document.selection.createRange){var s=document.selection.createRange();s.moveStart("character",-y.value.length);q=s.text.length}var v=f(D,t.autocomplete,t);if(t.autocomplete_action=="selection"){if(v.length){var F;if(t.dictionary_map){F=t.dictionary_map(v[0])}else{F=v[0]}F=F.replace(r,"");if(D.substr(q+1,F.length+1)!=F){y.value=D.substr(0,q)+F+D.substr(q)}var C=q+F.length;if(y.setSelectionRange){y.setSelectionRange(q,C)}else{if(y.createTextRange){var x=y.createTextRange();x.collapse(true);x.moveStart("character",q);x.moveEnd("character",C);x.select()}}}}else{if(t.autocomplete_action=="list"){if(v.length){var B=j(y),A=B.offset(),z=B.closest(t.tag_class),u=j("#tagbox_autocomplete_sugestions"),E=false,w="<ul>";j.each(v,function(G,H){if(t.dictionary_map){F=t.dictionary_map(H)}else{F=H}w+="<li>"+F+"</li>"});w+="</ul>";if(u.size()===0){u=j('<div id="tagbox_autocomplete_sugestions"></div>');E=true}u.css({position:"absolute",zIndex:300,top:(A.top+B.outerHeight())+"px",left:A.left+"px"});u.html(w);if(E){u.insertAfter(z.get(0))}}else{j("#tagbox_autocomplete_sugestions").remove()}}else{if(j.isFunction(t.autocomplete_action)){t.autocomplete_action.call(this,v)}}}}function n(r,q){return j(q.suggestion_links).filter(function(){return j(this).text()==r})}function g(s){s.stopPropagation();settings=o(s.target);var r=j(s.target);if(r.is(".close")){if(settings.close){var q=settings.close.call(r,s,settings);if(typeof q==="boolean"){return q}}n(j(this).closest(settings.tag_class).find("input").val(),settings).removeClass("active");if(settings.fx){j(this).remove()}else{j(this).remove()}return false}if(r.is(settings.tag_class)){r.tagboxNewTagBefore(undefined,settings);r.prev(settings.tag_class).find(":input").focus()}}function i(q){this.initialValue=this.value;j(this).parent().parent().parent().parent().addClass("active")}function e(r){var q=o(r.target);j(this).parent().parent().parent().parent().removeClass("active");if(!j.trim(j(this).val())){setTimeout(function(){j(r.target).closest(q.tag_class).remove()},100)}else{if(q.suggestion_links){if(this.initialValue!=this.value){n(this.initialValue,q).removeClass("active")}n(this.value,q).addClass("active")}}}function m(s){if(s.keyCode==8){if(s.keyCode==13){s.preventDefault()}if(!j.trim(j(this).val())){var r=o(s.target),q=j(this).closest(r.tag_class),t=q.prev(r.tag_class);if(t.length){t.find(":input").focus();q.remove();s.preventDefault()}}}if(s.keyCode==9||s.keyCode==13){var r=o(s.target);if(!s.shiftKey&&j.trim(j(this).val())&&!j(this).closest(r.tag_class).next(r.tag_class).length){var q=j(this).closest(r.tag_class).tagboxNewTagAfter(undefined,r);j(this).closest(r.tag_class).find("span").text(this.value);setTimeout(function(){q.next(r.tag_class).find("input").focus()},50);return true}}}function l(w,q){var v=j(this),u=this.value,t=o(w.target);if(t.autocomplete&&u.length&&(q||String.fromCharCode(w.keyCode).match(/[a-z0-9@._-]/gim))){if(t.autocomplete.url){}b(this,t)}v.siblings("span").html(d(u));if((t.separator).test(u)){var r=k(u,t);if(!r){return}if(r.length===1){r.push("")}tag=v.closest(t.tag_class);v.val(r[0]).siblings("span").html(d(r[0]));var x=[];for(var s=r.length-1;s>0;s--){x.push(j(tag).tagboxNewTagAfter(r[s],t).next())}x.shift().find("input").focus();if(!j.trim(r[0])){tag.remove()}}}function k(t,s){if(!t||t.constructor!=String){return t}if(s.grouping&&t.indexOf(s.grouping)!==-1){var r=[t.indexOf(s.grouping),t.lastIndexOf(s.grouping)];if(r[0]==r[1]){return false}else{var q=new RegExp(("^"+s.grouping)+".*"+(s.grouping+"$"));if(t.match(q)&&t.match(new RegExp(s.grouping,"g")).length==2){return}else{t=c(t,s)}}}if(t.constructor===String){t=t.split(s.separator)}return t}function h(s,r){var s=s||"",q=j(r.tag).clone(true);q.find("input").siblings("span").html(d(s)).end().val(s).attr("name",r.name).attr("id",r.id);return q}function d(q){return q.replace(/\s/g,"&nbsp;").replace("<","&lt;")+"M"}}(jQuery));