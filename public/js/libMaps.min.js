var Lib=Lib||{};Lib.Maps={map:null,displayRegion:{defaultOptions:{center:[],zoom:5,mapTypeId:google.maps.MapTypeId.HYBRID,bounds:[],mapElementId:"",icons:{album:"/images/default/markerAlbum.png",news:"/images/default/markerNews.png",photo:"/images/default/markerPhoto.png",spot:"/images/default/markerSpot.png",user:"/images/default/markerUser.png",video:"/images/default/markerVideo.png",shadow:"/images/default/marker-shadow.png",}},options:{},map:null,markers:[],items:[],itemCount:{},itemTypeDisplay:{},infoWindows:[],showTypes:[],init:function(e,h){var g=this;var i=this.options=jQuery.extend(this.defaultOptions,e);if(i.center.length==2){var b=new google.maps.LatLng(i.center[0],i.center[1])}else{var b=new google.maps.LatLng((parseFloat(i.bounds[0])+parseFloat(i.bounds[2]))/2,(parseFloat(i.bounds[1])+parseFloat(i.bounds[3]))/2)}var d={zoom:i.zoom,center:b,mapTypeId:i.mapTypeId};var c=window.map=this.map=new google.maps.Map(document.getElementById(i.mapElementId),d);var f=function(j){Lib.Maps.displayRegion.loadItemsInBounds()};if(i.bounds.length==4){var a=new google.maps.LatLngBounds(new google.maps.LatLng(i.bounds[0],i.bounds[1]),new google.maps.LatLng(i.bounds[2],i.bounds[3]));c.fitBounds(a);google.maps.event.addDomListenerOnce(c,"bounds_changed",function(){f("bounds_changed");google.maps.event.addDomListener(c,"dragend",function(){f("dragend")});google.maps.event.addDomListener(c,"zoom_changed",function(){f("zoom_changed")})})}else{google.maps.event.addDomListener(c,"dragend",function(){f("dragend no bounds")});google.maps.event.addDomListener(c,"zoom_changed",function(){f("zoom_changed no bounds")})}this.setupPage()},setupPage:function(){var b=this;var c='		<div id="mapItemTools">					<ul class="mapFilters">					</ul>				</div>';$("#mapZone").append(c);var a="";$("#mapItemsSummary li").each(function(){var d=$(this).find("span.itemType").text();var g=$(this).attr("class");b.showTypes[g]=true;var f=' checked="checked"';var e=$(this).find("span.count").text();a+='<li class="'+$(this).attr("class")+'"><label><input type="checkbox"'+f+' class="markerFilter" id="filter'+g+'" name="filter['+g.toLowerCase()+']"/> '+d+' <span class="count">('+e+")</span></label></li>"});if(a){$(".mapFilters").append(a)}$("#mapItemsSummary").remove();$("table.mapItems dl.position").addClass("closed");$("table.mapItems dl.position.closed").one("click",function(){$(this).removeClass("closed").addClass("open")});$(".mapFilters").delegate("input.markerFilter","click",function(){b.applyFilter(this)});$("table.mapItems").tablesorter();$("#regionTabs").tabs({show:function(f,d){if(d.index!=0){return}google.maps.event.trigger(map,"resize")}})},hideInfoWindowsExcept:function(b){for(var a in this.infoWindows){if(a==b&&b!==null){this.infoWindows[a].open(this.map,this.markers[a])}else{this.infoWindows[a].close()}}},resetFilter:function(){var a="";for(var e in Lib.Maps.itemCount){var b=Lib.Maps.displayRegion.itemTypeDisplay[e];if(typeof(this.showTypes[e])=="undefined"){console.log(e+" undefined in showTypes");continue}else{var d=this.showTypes[e]?' checked="checked"':"";var c=Lib.Maps.itemCount[e]}a+='<li class="'+e+'"><label><input type="checkbox"'+d+' class="markerFilter" id="filter'+e+'" name="filter['+e.toLowerCase()+']"/> '+b+' <span class="count">('+c+")</span></label></li>"}$(".mapFilters").html(a)},applyFilter:function(e){this.hideInfoWindowsExcept(null);var b=$(e).parent().parent().attr("class");var d=($(e).attr("checked"));if(typeof(this.showTypes[b])==undefined||this.showTypes[b]==d){return}this.showTypes[b]=d;for(var c in this.markers){if(this.markers[c].itemType!=b){continue}this.markers[c].setVisible(this.showTypes[this.markers[c].itemType])}var a=new Date().getTime()},loadMarkers:function(g){this.markers=[];this.infoWindows=[];Lib.Maps.itemCount={};for(var d=0,f=g.length;d<f;d++){var j=g[d],a=this.showTypes[j.itemType];var b=new google.maps.MarkerImage(this.options.icons[j.itemType],new google.maps.Size(21,34),new google.maps.Point(0,0),new google.maps.Point(10,17));var h=new google.maps.MarkerImage(this.options.icons.shadow,new google.maps.Size(39,34),new google.maps.Point(0,0),new google.maps.Point(10,17));var e=new google.maps.Marker({position:new google.maps.LatLng(parseFloat(j.position[0]),parseFloat(j.position[1])),map:this.map,title:j.singularDisplayType+" - "+j.title,visible:a,icon:b,shadow:h});e.itemType=j.itemType;var c=new google.maps.InfoWindow({content:'<div class="mapInfoWindow '+j.itemType+'">'+j.link+"<br/>"+j.info+"</div>"});c.itemId=j.itemId;Lib.Maps.displayRegion.addClickListener(map,e,c);this.markers[j.itemTypeId]=e;this.infoWindows[j.itemTypeId]=c;if(typeof(Lib.Maps.itemCount[j.itemType])=="undefined"){Lib.Maps.itemCount[j.itemType]=1}else{Lib.Maps.itemCount[j.itemType]+=1}Lib.Maps.displayRegion.itemTypeDisplay[j.itemType]=j.displayType}},addClickListener:function(c,a,b){google.maps.event.addListener(a,"click",function(){b.open(c,a)})},loadItemsInBounds:function(){var d=this.map.getBounds(),e=d.getNorthEast(),a=d.getSouthWest(),b=[a.lat(),a.lng(),e.lat(),e.lng()],c=this;$.ajax({url:"/ajax/getitemsinbounds/",dataType:"json",data:{b:b.join(",")},success:function(f){for(var g in c.markers){google.maps.event.clearListeners(c.markers[g]);c.markers[g].setMap(null)}Lib.Maps.displayRegion.loadMarkers(f);Lib.Maps.displayRegion.resetFilter()},error:function(g,h,f){console.log(h)}})}},displayItem:{defaultOptions:{center:[],zoom:8,mapTypeId:google.maps.MapTypeId.HYBRID,mapElementId:"",regionDetails:""},options:{},map:null,init:function(g,h){var c=this.options=jQuery.extend(this.defaultOptions,g);var e=new google.maps.LatLng(parseFloat(c.center[0]),parseFloat(c.center[1]));var b={zoom:parseInt(c.zoom),center:e,mapTypeId:c.mapTypeId};var f=this.map=new google.maps.Map(document.getElementById(c.mapElementId),b);var a=this.marker=new google.maps.Marker({position:e,map:f});if(c.regionDetails){var d=new google.maps.InfoWindow({content:c.regionDetails});google.maps.event.addListener(a,"click",function(){d.open(f,a)})}}},editItem:{defaultOptions:{mapElementId:"mapElement",center:[],zoom:8,hasMarker:false,bounds:[],mapTypeId:google.maps.MapTypeId.HYBRID,mapLabel:"",clearLocation:"clearLocation",locateMe:"locateMe",width:"45em",height:"20em"},options:{},map:null,init:function(f,h){var i=this.options=jQuery.extend(this.defaultOptions,f);this.setupPage();var c=new google.maps.LatLng(parseFloat(i.center[0]),parseFloat(i.center[1]));var d={zoom:parseInt(i.zoom),center:c,mapTypeId:i.mapTypeId};var b=this.map=new google.maps.Map(document.getElementById(i.mapElementId),d);if(i.hasMarker){var e=this.marker=new google.maps.Marker({position:c,map:b})}else{var e=this.marker=null}if(i.bounds.length==4){var a=new google.maps.LatLngBounds(new google.maps.LatLng(i.bounds[0],i.bounds[1]),new google.maps.LatLng(i.bounds[2],i.bounds[3]));google.maps.event.addDomListenerOnce(b,"bounds_changed",function(){var j=b.getZoom();Lib.Maps.restrictMapToBounds(b,a,j)});b.fitBounds(a)}var g=this;google.maps.event.addListener(b,"click",function(k){var j=new google.maps.LatLng(k.latLng.lat(),k.latLng.lng());g.handleClick(j)});google.maps.event.addListener(b,"maptypeid_changed",function(){g.updateMapType()});google.maps.event.addListener(b,"zoom_changed",function(){$("#zoom").val(g.map.getZoom())});$("#clearLocation").click(function(){if(e){e.setMap(null)}$("#latitude,#longitude").val("");$("#zoom").val(0);$("#locationFlag").val(0)});$("#locateMe").click(function(){if(!!navigator.geolocation){navigator.geolocation.getCurrentPosition(function(k){var j=new google.maps.LatLng(k.coords.latitude,k.coords.longitude);g.updateMarker(j)})}})},setupPage:function(){var a="";if(!!navigator.geolocation){a='<li><a href="javascript:void(0)" class="actionLinkContainer" id="locateMe">'+this.options.locateMe+"</a></li>"}$("#fieldset-locationGroup").children("p.element-group").hide().end().append('			                <p class="element-group">			                	<label class="form-element-label" id="mapLabel">'+this.options.mapLabel+'</label>			                	<span id="mapElement" style="display:block;margin-top:2em;width:'+this.options.width+"; height:"+this.options.height+';"></span>			                    <ul id="mapTools">			                    	<li><a href="javascript:void(0)" class="actionLinkContainer" id="clearLocation">'+this.options.clearLocation+"</a></li>			                    	"+a+"			                    </ul>			                </p>			    ")},updateMapType:function(){switch(this.map.getMapTypeId()){default:case"roadmap":$("#mapType").val(0);break;case"satellite":$("#mapType").val(1);break;case"hybrid":$("#mapType").val(2);break;case"terrain":$("#mapType").val(3);break}},updateMarker:function(a){if(this.marker==null){var b=this.marker=new google.maps.Marker({position:a,map:this.map})}else{this.marker.setMap(this.map);this.marker.setPosition(a)}this.map.panTo(a);$("#latitude").val(a.lat());$("#longitude").val(a.lng());$("#locationFlag").val(1);this.updateMapType()},handleClick:function(a){this.updateMarker(a)}},addRegionOverlay:function(b){var a=new google.maps.KmlLayer(b,{suppressInfoWindows:true});a.setMap(map);google.maps.event.addListener(a,"click",function(d){var c=new google.maps.LatLng(d.latLng.lat(),d.latLng.lng());handleClick(c)})},restrictMapToBounds:function(c,a,b){var d=function(){if(a.contains(c.getCenter())){return}var k=c.getCenter(),f=k.lng(),j=k.lat(),h=a.getNorthEast().lng(),g=a.getNorthEast().lat(),e=a.getSouthWest().lng(),i=a.getSouthWest().lat();if(f<e){f=e}if(f>h){f=h}if(j<i){j=i}if(j>g){j=g}c.setCenter(new google.maps.LatLng(j,f))};google.maps.event.addListener(c,"dragend",d);google.maps.event.addListener(c,"zoom_changed",function(){d();if(c.getZoom()<b){c.setZoom(b)}})}};