var Lib=Lib||{};Lib.Chat={states:["closed","loadingDeps","loadingContent","ready","paused","failure"],currentState:null,defaultOptions:{path:"/",protocol:"http",host:"www.redesign-zend.fr",port:"8080",socketIo:"socket.io.js",join:"has joined the chatroom.",leave:"has left the chatroom."},options:{},depsLoaded:false,initialContentLoaded:false,messageBuffer:[],socket:null,useLocalStorage:false,debug:function(b,a){if(typeof(console)!="undefined"){if(typeof(a)=="undefined"){console.log(b)}else{console.log(b,a)}}},init:function(c,a){try{this.useLocalStorage=!!localStorage.getItem}catch(b){this.useLocalStorage=false}this.debug("session:",$.cookie("PHPSESSID"));this.options=$.extend(this.defaultOptions,c);if(a){this.moveToStateLoadingDeps()}else{this.moveToStateClosed()}this.setupHandlers()},setupHandlers:function(){var a=this;$("#chatOpen").click(function(){a.loadChat();return false});$("#chatExit").click(function(){a.moveToStateClosed();return false});$("#chatToggle").click(function(){switch($(this).attr("class")){case"chatMin":a.moveToStatePaused();break;case"chatMax":a.moveToStateReady();break;default:a.loadChat();break}});$("#chatForm").submit(function(){a.sendMessage();return false});$("#chatSubmit").click(function(){a.sendMessage();return false})},setupConnection:function(){WEB_SOCKET_SWF_LOCATION="http://www.redesign-zend.fr/js/WebSocketMain.swf";var b=this,a=this.socket=new io.Socket(null,{rememberTransport:true,port:b.options.port,transports:["websocket","flashsocket","htmlfile","xhr-multipart","xhr-polling","jsonp-polling"]});b.debug("-setupConnection");a.on("connect",function(){b.moveToStateLoadingContent()});a.on("message",function(c){b.debug("message",c);if(c.type=="userInfo"){b.moveToStateReady(c.name)}else{if(c.type=="userInfoError"){b.debug("* connection failed *");b.moveToStateConnectionFailure()}else{b.saveMessageToBuffer(c)}}});a.on("disconnect",function(c){});this.connect()},connect:function(){this.debug("-connect");this.socket.connect()},saveMessageToBuffer:function(a){this.messageBuffer.push(a);if(this.messageBuffer.length>15){this.messageBuffer.shift()}this.debug("messageBuffer after write",this.messageBuffer);localStorage.setItem("chatMessages",JSON.stringify(this.messageBuffer));this.debug("chatMessages after write",JSON.parse(localStorage.getItem("chatMessages")));this.appendMessage(a)},sendMessage:function(a){if(!a){var b=$("input#chatMessage").val();$("input#chatMessage").val("")}else{var b=a}if(b.length>0){this.socket.send({text:b})}},appendMessage:function(d){var c,a=new Date(d.time);switch(d.type){case"joined":c=this.options.join;break;case"left":c=this.options.leave;break;default:c=d.text;break}var b=a.toLocaleDateString()+" @ "+a.toLocaleTimeString();$("#chatConversation").append('<li class="'+d.type+'"> <a target="_blank" title="'+b+'" class="from" href="'+d.from.link+'">'+d.from.name+'</a><span class="msg">'+c+"</span></li>");$("#chatConversation").scrollTop($("#chatConversation")[0].scrollHeight)},clearMessages:function(){$("#chatConversation").empty()},loadChat:function(){this.debug("-loadChat");if(!this.depsLoaded){this.moveToStateLoadingDeps()}else{this.connect()}},moveToStateClosed:function(){this.debug("-moveToStateClosed");if(this.socket!=null){this.socket.disconnect()}this.currentState=this.states.closed;this.drawClosed();this.clearMessages()},moveToStateLoadingDeps:function(){this.debug("-moveToStateLoadingDeps");var a=this;this.currentState=this.states.loadingDeps;this.drawLoading();yepnope([{load:[this.options.protocol+"://"+this.options.host+"/"+this.options.path+this.options.socketIo],callback:function(){a.depsLoaded=true;a.setupConnection()}}])},moveToStateLoadingContent:function(){this.debug("-moveToStateLoadingContent");this.drawLoading();this.currentState=this.states.loadingContent;this.clearMessages();var a=JSON.parse(localStorage.getItem("chatMessages"));if(a===null){a=[]}this.debug("useLocalStorage: ",this.useLocalStorage);this.debug("found storedMessages: ",a.length);for(var c=0,b=a.length;c<b;c++){var d=a[c];this.appendMessage(d)}this.socket.send({sessionId:$.cookie("PHPSESSID")})},moveToStateReady:function(a){this.debug("-moveToStateReady - "+a);this.drawReady();this.currentState=this.states.ready;$("#chatMessage").focus()},moveToStatePaused:function(){this.debug("-moveToStatePaused");this.drawPaused();this.currentState=this.states.paused},moveToStateConnectionFailure:function(){this.debug("-moveToStateConnectionFailure");this.drawFailure();this.currentState=this.states.failure},drawOpen:function(){$("#chatContainer").attr("class","open");$("#chatOpen").hide();$("#chatExit").show();$("#chatToggle").attr("class","chatMin")},drawLoading:function(){$("#chatContainer").attr("class","open loading");$("#chatOpen").hide();$("#chatExit").show()},drawReady:function(){$("#chatContainer").attr("class","open ready");$("#chatOpen").hide();$("#chatExit").show();$("#chatToggle").attr("class","chatMin")},drawPaused:function(){$("#chatContainer").attr("class","closed");$("#chatOpen").hide();$("#chatExit").show();$("#chatToggle").attr("class","chatMax")},drawFailure:function(){this.debug("TODO: draw connection failure");$("#chatContainer").attr("class","open");$("#chatOpen").hide();$("#chatExit").show()},drawClosed:function(){$("#chatContainer").attr("class","closed");$("#chatOpen").show();$("#chatExit").hide();$("#chatToggle").attr("class","")}};